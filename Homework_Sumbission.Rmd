---
title: "Homework Sumbission"
output:
  html_document: default
  pdf_document: default
date: "2024-11-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) #this makes the document default to have echo = TRUE
```

*The following is a template .rmd RMarkdown file for you to use for your homework submission.*

*Please Knit your .rmd to a PDF format or HTML and submit that with no identifiers like your name.*

*To create a PDF, first install tinytex and load the package. Then press the Knit arrow and select "Knit to PDF".*

## QUESTION 01: Data Visualisation for Science Communication

*Create a figure using the Palmer Penguin dataset that is correct but badly communicates the data. **Do not make a boxplot**.*

*Use the following references to guide you:*

-   [*https://www.nature.com/articles/533452a*](https://www.nature.com/articles/533452a){.uri}
-   [*https://elifesciences.org/articles/16800*](https://elifesciences.org/articles/16800){.uri}

*Note: Focus on visual elements rather than writing misleading text on it.*

### a) Provide your figure here:

```{r bad figure code, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}

# Make sure your figure is visible after you knit it. 

library(here)
library(tidyverse)
library(janitor)
library(dplyr)
library(knitr) 
library(rmarkdown) 
library(here) 
library(tidyverse) 
library(janitor)
library(ggplot2)

source(here("functions", "cleaning.r"))

penguins_untidy <- read_csv(here("data", "penguins_raw.csv"))

penguins_tidy <- penguins_untidy %>%
  cleaning_columns() %>% #automatically snake case
  shorten_species() %>%
  remove_empty_columns_rows() %>% 
  remove_NA() 


ggplot(data = penguins_tidy, aes(x = date_egg, y = body_mass_g)) +
  stat_smooth(method = "lm", se = FALSE, color = "darkred", 
              geom = "line", 
              linewidth = 1,  # Increase line thickness
              arrow = arrow(length = unit(0.2, "cm"), ends = "last", type = "closed")) +
  geom_point(color = "darkred", alpha = 0.2) +
  coord_fixed(ratio = 2) +
  theme_bw() +
  theme(axis.text.y = element_blank()) +
  scale_y_continuous() +
  coord_cartesian(ylim = c(4150, 4300)) +

    scale_x_date(
    breaks = as.Date(c("2008-01-01", "2008-07-01", "2009-01-01", "2009-07-01", "2010-01-01")),
    labels = c(expression(bold("2008-01")), "2008-07", "2009-01", "2009-07", "2010-01")
  ) +
  labs(
    title = "Palmer Penguin Body Mass over Time",
    x = "Time since Chef Smith's Arrival",
    y = "Body Mass (g)"
  )

#^fix X-axis cut-off >55 words too long
```

### b) Write about how your design choices mislead the reader about the underlying data (100-300 words).

Imagine a scenario where I am in an argument with Chef Smith, who was hired at the start of 2008 to my Antarctic field station workplace. I devise a plan to get them fired by convincing the public that their food waste is causing an obesity epidemic around the Palmer Station, Antarctica LTER. Taking to twitter, I share the above graph.

Points of deception:

-   I have started the graph from where the linear relationship begins, rather than 0 or another appropriate point. This exaggerates the steepness of the linear relationship, which would look almost negligible if seen as it should be.

-   I am only using the species Gentoo, but extrapolating to all Palmer Penguin's in the title. In fact, Adelie Penguins have gotten smaller since Chef Smith's arrival. (N.B. I am taking the graph title and axis labels to be "visual elements").

-   I have elected to make the line red, a colour commonly associated with negatives. This aims to distract from the fact that weight increase isn't intrinsically negative.

-   I have made the line an arrow. This aims at convincing the reader of a continued projected increase should Chef Smith remain employed.

-   Rather than labeling with the objective "Date", I have drawn attention to how time relates to my intended point.

-   I have used the code "coord_fixed(ratio = 10)" which stretches the graph vertically and hugely exaggerates the steepness of the line.

-   I have made the individual label 2008-01 bold. I did this while ensuring the axes remain the same as when they are entered in a repeatable manner, so it remains technically "correct". The intended effect is to again call attention to the false association between Chef Smith's arrival and increased penguin body mass.

-   I used scale_y_continuous() along with coord_cartesian(ylim = c(x1, x2)). This enabled me to manipulate the y axis, while coord_cartesian() ensured that the "zoom effect" excludes the data points from the graph but not the lm(). This circumvents an issue where it looks too obviously fabricated without any data visible.

------------------------------------------------------------------------

## QUESTION 2: Data Analysis Pipeline

*Write a data analysis pipeline.*

*You should be aiming to write a clear explanation of the steps as well as clear code.*

*Your code should include the steps practiced in the lab session:*

*Written in the structure of a scientific paper.*

-   *Load the data*
-   *Appropriately clean the data*
-   *Create an Exploratory Figure (**not a boxplot**)*
-   *Save the figure*
-   ***New**: Run a statistical test*
-   ***New**: Create a Results Figure*
-   *Save the figure*

*An exploratory figure shows raw data, such as the distribution of the data. A results figure demonstrates the stats method chosen, and includes the results of the stats test or model.*

*Between your code, communicate clearly what you are doing and why.*

*Your text should include:*

-   *Introduction*

-   *Hypothesis*

-   *Stats Method*

-   *Results*

-   *Discussion*

-   *Conclusion*

*You will be marked on the following:*

1.  Your code for readability and functionality

2.  Your figures for communication

3.  Your text communication of your analysis

*Below is a template you can use.*

------------------------------------------------------------------------

### Introduction

-   What is the data?

The data features various pieces of information gathered on three species of Penguins around the Palmer Station, Antarctica. Collected variables include geographical data, various morphological characteristics, and details on reproductive success.

-   *Load the data*

I start by loading the libraries we will be using. To protect the environment, I will be using renv(). This is a package that ensures the packages we use have a record of which version was being used at the time we write our code. This prevents subsequent updates to packages from affecting our code's functionality.

I considered loading packages in a separate file and importing them with source(); however, opt not to as, despite keeping the code marginally cleaner, readers are forced to open an additional file and reduces the level of self-containment from the .Rmd file. Users can then use renv::status() to ensure the packages are correctly loaded in a consistent state.

```{r Libraries, echo=TRUE, message=FALSE, warning=FALSE}
# Make sure your code prints.

library(renv) 
library(knitr) 
library(rmarkdown) 
library(here) 
library(tidyverse) 
library(janitor)
library(tinytex)
library(svglite)
library(ragg)
library(car)
library(MASS)
library(gridExtra)

renv::status()
```

On to the data itself. This was downloaded from Canvas and placed in a file, created and named "data". I could load the data from the "palmerpenguins" package. However, more often in reality we will be loading data from files rather than R packages. Hence, I push the file to my GitHub Repository. If someone downloads the repository, this should be perfectly functional. I then like to look at the data.

```{r Data Exploration}
penguins_raw <- suppressMessages(read_csv(here("data", "penguins_raw.csv"), show_col_types = FALSE))

head(penguins_raw)
```

This uses the read_csv() function, contained in tidyverse and producing a "tibble". Tibbles are a "modern take on data frames" (R Core Team, 2024). The here() function avoids privacy concerns by sidestepping entering file directories and improves operating system cross-compatibility.

Next in the pipeline, we can further familiarize ourselves with the data by looking at the column names

```{r}
colnames(penguins_raw)
```

It is apparent from the mixture of styles (e.g. camel case and sentence case) and abundance of error causing characters (e.g. spaces, brackets, and slashes) that we should clean our dataset. Here, it is important to resist the urge to edit the raw data, as this ruins reproducibility. Instead we should make a new dataset.

```{r data cleaning}
source(here("functions", "cleaning.r"))

penguins_clean <- penguins_raw %>%
  cleaning_columns() %>% #automatically snake case
  shorten_species() %>%
  remove_empty_columns_rows() %>% 
  remove_NA() 

colnames(penguins_clean)

```

The above code begins by sourcing a file named "cleaning.r" from within our directory. It uses Dr France's functions for cleaning the data, which itself uses generic cleaning functions from the "janitor" package. By using \`source()\` and a separate file, we streamline our work by ensuring any functions which may be used multiple times in the project only need to be edited in one place. The code also makes use of a "pipe", here styled as part of the "tidyverse" package. It is essentially equivalent to the instruction "and then".

-   *Create an Exploratory Figure (**not a boxplot**)*

I'm interested in whether there is any relationship between the categorical variable "clutch_completion" and "body_mass_g". More specifically, I am interested to look at whether body mass as an explanatory variable has any noticable influence on fitness, which I will use clutch completion as a proxy for. I expect this to naturally vary between species and sex, so want to control for those factors. I will assume that time and geographical factors are independent.

Next in my data pipeline, I will subset the data into these factors of interest with the `select()` function

```{r data subset}
body_mass_clutch <- penguins_clean %>%
  dplyr::select(species, body_mass_g, sex, clutch_completion) #specify package as MASS has conflict

```

Rather than using a boxplot, I have used a violin plot. This is another useful exploratory graph technique with a bigger focus on data distribution compared to a boxplot's focus on summary statistics. **Mistake. Exploratory figure must show raw data.**

-   

-   An exploratory figure shows the reader the raw data

-   

-   Before any modelling, you need to demonstrate the shape of the data

-   

-   This is a good way to check your data is looking as you expect

-   

```{r explanatory figure}
#combine data columns into one for colour coding the graph. Make new dataset to avoid overwriting

body_mass_clutch_updated <- body_mass_clutch
  
body_mass_clutch_updated$species_clutch <- paste(body_mass_clutch$species, body_mass_clutch$clutch_completion, sep = "_")
  
  species_shades <- c(
    "Adelie_No" = "#006d4c",  
    "Adelie_Yes" = "#66c2a4", 
    "Chinstrap_No" = "#ff8c66",  
    "Chinstrap_Yes" = "#ffb399", 
    "Gentoo_No" = "#c653c6",  
    "Gentoo_Yes" = "#ecc6ec"
  )
  
  
violin_plot <- ggplot(body_mass_clutch_updated, aes(x = clutch_completion, y = body_mass_g, fill = species_clutch)) +
    geom_violin() +
    stat_summary(fun = mean, geom = "crossbar", width = 0.9, linewidth = 0.2, color = "black") + # Add mean lines
    facet_wrap(~species) +
    theme_minimal() +
    scale_fill_manual(values = species_shades) + # Use custom color scheme for species and clutch completion
    labs(title = "Body Mass by Clutch Completion for Each Species",
         x = "Clutch Completion",
         y = "Body Mass (g)",
         fill = "Species and Clutch Completion") + 
    theme_bw() +
    theme(
      legend.position = "none",
      strip.text = element_text(size = 12),
      ) +
  geom_jitter(
        aes(color = ),
        alpha = 0.1,
        show.legend = FALSE, 
        position = position_jitter(width = 0.2, seed = 0)) # seed number to add reproducibility

print(violin_plot)

```

I considered adding the plotting code to a function file; however, since I am only asked to do this plot decided it is simpler to display the code in the document.

We should now save the exploratory figure.

```{r saving explanatory figure}
save_plot_svg <- function(plot, 
                                  filename, size, scaling){
    size_inches = size/2.54
    svglite(filename, width   = size_inches, 
                      height  = size_inches, 
                      scaling = scaling)
    print(plot)
    dev.off()
}

save_plot_svg(violin_plot, 
                       here("figures", "violin_plot.svg"), 
                       size = 19, scaling = 1.5)
```

Describe making plot. Used function. Made to fit computer screen.

### Hypothesis

$\text{H}_0 :$ There is no significant difference in clutch completion according to body mass.

$\text{H}_{a1} :$ Penguins with greater body mass have significantly higher clutch completions.

$\text{H}_{a2} :$ Penguins with greater body mass have significantly lower clutch completions.

### Statistical Methods

I will model the data using a binomial logistic regression with clutch_completion as the response variable.

```{r Statistics}
#convert completion into 1 = yes, 0 = no.
body_mass_clutch$clutch_completion_binary <- ifelse(body_mass_clutch$clutch_completion == "Yes", 1, 0) # new column to avoid over

logistic_regression_model <- glm(clutch_completion_binary ~ body_mass_g + sex + species, 
             family = binomial(link = "logit"), 
             data = body_mass_clutch)
summary(logistic_regression_model)



```

The initial results indicate that there is no significant effect of

```{r}
vif(logistic_regression_model)
```

This indicates moderate multicollinearity between factors, especially body_mass_g. However, it is not so extreme as to exclude any variables from the model. Instead we should be cautious to consider multicollinearities potential bias when interpreting the model.

```{r}
stepwise_model <- stepAIC(logistic_regression_model, direction = "both")
summary(stepwise_model)
```

Similarly, when verifying our results by performing selection to ensure there is no over-fitting, We see that Species is the only significant factor in determining clutch completion that we included in our model.

Model AIC nearly identical.

### Results & Discussion

Because the AIC values for my full model and selected model are nearly identical I will plot and then discuss the results from the full model.

```{r Plotting Results, message=FALSE}

# Make sure your code prints. 

# Extract coefficients and standard errors
coefficients <- summary(logistic_regression_model)$coefficients
odds_ratios <- exp(coefficients[, "Estimate"])  # Convert log-odds to odds ratios
conf_int <- exp(confint(logistic_regression_model))  # Confidence intervals for odds ratios

results_df <- data.frame(
    Name = c(
    "Intercept",
    "Body Mass (grams)",
    "Male (vs Female)",
    "Chinstrap (vs Adelie)",
    "Gentoo (vs Adelie)"
  ),
  Odds_Ratio = odds_ratios,
  CI_Lower = conf_int[, 1],
  CI_Upper = conf_int[, 2],
  p_value = coefficients[, "Pr(>|z|)"],
  stringsAsFactors = FALSE  # Ensure character data is not converted to factors
)

results_df$Odds_Ratio <- formatC(results_df$Odds_Ratio, format = "f", digits = 3)
results_df$CI_Lower <- formatC(results_df$CI_Lower, format = "f", digits = 3)
results_df$CI_Upper <- formatC(results_df$CI_Upper, format = "f", digits = 3)
results_df$p_value <- formatC(results_df$p_value, format = "f", digits = 3)

results_df$Significance <- cut(as.numeric(results_df$p_value),
                               breaks = c(-Inf, 0.001, 0.01, 0.05, 0.1, Inf),
                               labels = c("***", "**", "*", ".", " "))

# Remove default row names
rownames(results_df) <- NULL


# View the new data frame
results_df

```

Saving table

```{r}
# Save the table as an SVG



svglite(here("figures","results_table.svg", width = 8, height = 4))  # Set dimensions
grid.table(results_df)  # Render the table as a grid
dev.off()  # Close the SVG devic


save_plot_svg(results_df, 
                       here("figures", "table.svg"), 
                       size = 19, scaling = 1.5)


```

### Conclusion

------------------------------------------------------------------------

## QUESTION 3: Open Science

### a) GitHub

*Upload your RProject you created for **Question 2** and any files and subfolders used to GitHub. Do not include any identifiers such as your name. Make sure your GitHub repo is public.*

*GitHub link:*

*You will be marked on your repo organisation and readability.*

### b) Share your repo with a partner, download, and try to run their data pipeline.

*Partner's GitHub link:*

*You **must** provide this so I can verify there is no plagiarism between you and your partner.*

### c) Reflect on your experience running their code. (300-500 words)

-   *What elements of your partner's code helped you to understand and run their data pipeline?*

-   *Did it run? Did you need to fix anything?*

-   *What suggestions would you make for improving their code to make it more understandable or reproducible, and why?*

-   *If you needed to alter your partner's figure using their code, do you think that would be easy or difficult, and why?*

### d) Reflect on your own code based on your experience with your partner's code and their review of yours. (300-500 words)

-   *What improvements did they suggest, and do you agree?*

-   *What did you learn about writing code for other people?*

### e) What are the main barriers for scientists to share their data and code, and what could be done to overcome them? (500-700 words)

-   Maitner et al. Code sharing increases citations, but remains uncommon. <https://doi.org/10.21203/rs.3.rs-3222221/v1>
-   Trisovic et al. A large-scale study on research code quality and execution. <https://rdcu.be/dZB7x>
-   A Rock-Star Researcher Spun a Web of Lies---and Nearly Got Away with It. <https://thewalrus.ca/a-rock-star-researcher-spun-a-web-of-lies-and-nearly-got-away-with-it/>
-   Gomes et al. Why don't we share data and code? Perceived barriers and benefits to public archiving practices <https://doi.org/10.1098/rspb.2022.1113>
